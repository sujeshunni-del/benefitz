import React, { useState, useRef, useEffect, useMemo, useCallback } from 'react';
import { 
  User, Briefcase, GraduationCap, Sparkles, Plus, Trash2, Download, Eye, 
  PenTool, ChevronDown, ChevronUp, Mail, Phone, MapPin, Linkedin, Globe,
  Facebook, Instagram, MessageCircle, FileText, Palette, Image as ImageIcon,
  Camera, Mic, Loader, Check, Wand2, StopCircle, Search, Send, ArrowLeft, UploadCloud,
  ZoomIn, ZoomOut, FileJson, FileType, Printer, X, Settings, Key,
  Bold, Italic, Underline, Strikethrough, List, ListOrdered, 
  AlignLeft, AlignCenter, AlignRight, AlignJustify, Subscript, Superscript,
  Briefcase as BriefcaseIcon, GripVertical, Calendar, Smartphone, Map
} from 'lucide-react';

// --- FULL JOB DATABASE (Connected) ---
const JOB_DB = {
  "Medical & Healthcare": [
    "Nursing Assistant (CNA)", "Patient Care Technician (PCT)", "Medical Assistant (MA)", "Home Health Aide (HHA)",
    "Licensed Practical Nurse (LPN)", "Registered Nurse (RN)", "Nurse Manager", "Nurse Practitioner (NP)",
    "Clinical Nurse Specialist", "Nurse Anesthetist (CRNA)", "Midwife", "School Nurse", "Travel Nurse",
    "Dialysis Nurse", "Critical Care Nurse", "Emergency Room Nurse", "Operating Room Nurse", "Labor and Delivery Nurse",
    "Oncology Nurse", "Pediatric Nurse", "Psychiatric Nurse", "Public Health Nurse", "Case Management Nurse",
    "Medical Doctor (MD)", "Doctor of Osteopathic Medicine (DO)", "Family Medicine Physician", "General Practitioner",
    "Internal Medicine Physician", "Pediatrician", "Surgeon", "Chief Medical Officer (CMO)", "Hospitalist",
    "Anesthesiologist", "Cardiologist", "Dermatologist", "Endocrinologist", "Gastroenterologist", "Neurologist",
    "Obstetrician-Gynecologist (OB-GYN)", "Oncologist", "Ophthalmologist", "Orthopedic Surgeon", "Psychiatrist",
    "Radiologist", "Urologist", "Plastic Surgeon", "Neurosurgeon", "Thoracic Surgeon", "Vascular Surgeon",
    "Physical Therapist (PT)", "Physical Therapy Assistant", "Occupational Therapist (OT)", "Occupational Therapy Assistant",
    "Speech-Language Pathologist (SLP)", "Respiratory Therapist", "Recreational Therapist", "Massage Therapist",
    "Chiropractor", "Athletic Trainer", "Audiologist", "Dietitian", "Nutritionist", "Art Therapist", "Music Therapist",
    "Phlebotomist", "Radiologic Technologist (RT)", "MRI Technologist", "Ultrasound Technician", "Surgical Technologist",
    "Medical Laboratory Scientist", "Medical Lab Technician", "Cardiovascular Technologist", "Pharmacy Technician",
    "Pharmacist", "Dentist", "Dental Hygienist", "Dental Assistant", "Orthodontist", "Optometrist",
    "Mental Health Technician", "Licensed Clinical Social Worker (LCSW)", "Psychologist", "Mental Health Counselor",
    "Substance Abuse Counselor", "Marriage and Family Therapist", "Case Manager", "Social Worker",
    "Medical Coder", "Medical Biller", "Healthcare Administrator", "Medical Office Manager", "Health Information Technician",
    "Patient Care Coordinator", "Admissions Coordinator", "Medical Secretary", "Medical Transcriptionist",
    "Clinical Research Coordinator", "Hospital Administrator", "Practice Manager"
  ],
  "Tech & Software Development": [
    "Software Engineer", "Senior Software Engineer", "Staff Engineer", "Principal Engineer", "Distinguished Engineer",
    "Full Stack Developer", "Frontend Developer", "Backend Developer", "Web Developer", "Desktop Application Developer",
    "Mobile App Developer (iOS)", "Mobile App Developer (Android)", "Game Developer", "Embedded Systems Engineer",
    "Firmware Engineer", "Blockchain Developer", "Smart Contract Engineer", "AR/VR Developer", "Graphics Programmer",
    "Data Scientist", "Data Analyst", "Data Engineer", "Machine Learning Engineer", "AI Researcher",
    "Business Intelligence Analyst", "Big Data Engineer", "Database Administrator (DBA)", "Analytics Manager",
    "Computer Vision Engineer", "NLP Engineer", "Quantitative Analyst", "Data Architect", "Statistician",
    "DevOps Engineer", "Site Reliability Engineer (SRE)", "Cloud Architect", "Cloud Engineer", "Platform Engineer",
    "Systems Administrator", "Network Engineer", "Network Administrator", "Cybersecurity Analyst",
    "Information Security Manager", "Security Engineer", "Penetration Tester", "Security Architect",
    "SOC Analyst", "Incident Responder", "Forensic Analyst", "Identity and Access Management Specialist",
    "Chief Technology Officer (CTO)", "Chief Information Officer (CIO)", "VP of Engineering", "Director of Engineering",
    "Engineering Manager", "Tech Lead", "Product Manager", "Technical Product Manager", "Product Owner",
    "Scrum Master", "Agile Coach", "Project Manager", "Program Manager", "Release Manager", "IT Manager",
    "QA Engineer", "Software Tester", "Automation Engineer", "QA Lead", "Technical Support Engineer",
    "IT Support Specialist", "Help Desk Technician", "System Analyst", "Solutions Architect", "Technical Evangelist"
  ],
  "Creative & Arts": [
    "Author", "Novelist", "Poet", "Playwright", "Screenwriter", "Technical Writer", "Game Writer", 
    "Copywriter", "Content Creator", "Blogger", "Podcaster", "Ghostwriter", "Editor", "Proofreader",
    "Journalist", "Staff Writer", "Grant Writer", "Proposal Writer", "UX Writer", "Script Coordinator",
    "Game Designer", "Narrative Designer", "Graphic Designer", "Art Director", "Creative Director",
    "Illustrator", "Animator", "Concept Artist", "Storyboard Artist", "3D Modeler", "Character Artist",
    "Environment Artist", "VFX Artist", "Motion Graphics Designer", "UI/UX Designer", "Product Designer",
    "Industrial Designer", "Fashion Designer", "Textile Designer", "Interior Designer", "Set Designer",
    "Creative Strategist", "Creative Consultant", "Gallery Director", "Museum Curator", "Arts Administrator",
    "Cultural Program Manager", "Studio Manager", "Production Manager", "Casting Director", "Talent Agent",
    "Gallery Assistant", "Curatorial Assistant", "Freelance Artist", "Independent Contractor", 
    "Special Effects Technician", "Photographer", "Videographer", "Photo Editor", "Video Editor",
    "Cinematographer", "Camera Operator", "Lighting Technician", "Sound Engineer", "Music Producer",
    "Composer", "Musician", "Fine Artist", "Sculptor", "Painter", "Makeup Artist", "Costume Designer",
    "Actor", "Voice Actor", "Dancer", "Choreographer", "Director", "Producer", "Stage Manager"
  ],
  "Sales & Marketing": [
    "Sales Associate", "Sales Representative", "Account Executive", "Senior Account Executive", "Key Account Manager",
    "Sales Manager", "Director of Sales", "VP of Sales", "Chief Revenue Officer (CRO)",
    "Business Development Representative (BDR)", "Sales Development Representative (SDR)", "Business Development Manager",
    "Inside Sales Representative", "Field Sales Representative", "Territory Manager", "Regional Sales Manager",
    "National Sales Manager", "Channel Sales Manager", "Sales Operations Manager", "Sales Engineer",
    "Retail Sales Associate", "Store Manager", "Assistant Store Manager", "Wholesale Representative", "Real Estate Agent",
    "Marketing Coordinator", "Marketing Manager", "Director of Marketing", "VP of Marketing",
    "Chief Marketing Officer (CMO)", "Brand Manager", "Product Marketing Manager", "Digital Marketing Manager",
    "Content Marketing Manager", "Social Media Manager", "Community Manager", "SEO Specialist",
    "SEM Specialist", "Email Marketing Specialist", "Growth Hacker", "Marketing Analyst",
    "Market Research Analyst", "Public Relations Specialist", "Communications Manager", "Media Buyer",
    "Event Coordinator", "Event Manager", "Affiliate Marketing Manager", "Influencer Marketing Manager"
  ],
  "Finance & Accounting": [
    "Accountant", "Staff Accountant", "Senior Accountant", "Certified Public Accountant (CPA)",
    "Cost Accountant", "Tax Accountant", "Forensic Accountant", "Bookkeeper", "Accounts Payable Clerk",
    "Accounts Receivable Clerk", "Payroll Specialist", "Payroll Manager", "Accounting Manager", "Controller",
    "Financial Analyst", "Senior Financial Analyst", "Finance Manager", "Director of Finance",
    "VP of Finance", "Chief Financial Officer (CFO)", "Treasurer", "Treasury Analyst",
    "Auditor", "Internal Auditor", "External Auditor", "Risk Manager", "Compliance Officer",
    "Investment Banker", "Portfolio Manager", "Wealth Manager", "Financial Advisor", "Financial Planner",
    "Credit Analyst", "Loan Officer", "Mortgage Broker", "Underwriter", "Actuary", "Bank Teller",
    "Branch Manager", "Private Equity Associate", "Hedge Fund Analyst", "Venture Capitalist", "Trader"
  ],
  "Human Resources & Admin": [
    "HR Assistant", "HR Coordinator", "HR Generalist", "HR Manager", "HR Director", "VP of HR",
    "Chief Human Resources Officer (CHRO)", "Recruiter", "Technical Recruiter", "Talent Acquisition Manager",
    "Sourcing Specialist", "Onboarding Specialist", "Employee Relations Manager", "Benefits Administrator",
    "Compensation Manager", "Training and Development Manager", "Learning and Development Specialist",
    "HRIS Analyst", "Diversity and Inclusion Officer", "Labor Relations Specialist",
    "Administrative Assistant", "Executive Assistant", "Office Manager", "Receptionist",
    "Data Entry Clerk", "File Clerk", "Office Assistant", "Virtual Assistant", "Customer Service Representative",
    "Call Center Agent", "Travel Coordinator", "Event Planner", "Facilities Manager", "Mailroom Clerk"
  ],
  "Engineering (Non-Software)": [
    "Civil Engineer", "Structural Engineer", "Geotechnical Engineer", "Transportation Engineer", "Water Resources Engineer",
    "Mechanical Engineer", "Aerospace Engineer", "Automotive Engineer", "Robotics Engineer", "HVAC Engineer",
    "Manufacturing Engineer", "Industrial Engineer", "Quality Engineer", "Process Engineer", "Supply Chain Engineer",
    "Electrical Engineer", "Electronics Engineer", "Power Engineer", "Controls Engineer", "Instrumentation Engineer",
    "Chemical Engineer", "Petroleum Engineer", "Materials Engineer", "Metallurgical Engineer", "Ceramic Engineer",
    "Biomedical Engineer", "Environmental Engineer", "Safety Engineer", "Nuclear Engineer", "Mining Engineer",
    "Marine Engineer", "Naval Architect", "Surveyor", "Drafter", "CAD Technician", "Project Engineer"
  ],
  "Education & Academic": [
    "Teacher", "Preschool Teacher", "Kindergarten Teacher", "Elementary School Teacher",
    "Middle School Teacher", "High School Teacher", "Special Education Teacher", "ESL Teacher",
    "Substitute Teacher", "Teaching Assistant", "Tutor", "School Principal", "Assistant Principal",
    "Superintendent", "School Counselor", "School Psychologist", "Librarian",
    "Professor", "Associate Professor", "Assistant Professor", "Lecturer", "Adjunct Professor",
    "Dean", "Provost", "University President", "Department Chair", "Academic Advisor",
    "Admissions Officer", "Registrar", "Financial Aid Officer", "Student Affairs Officer",
    "Researcher", "Postdoctoral Fellow", "Research Assistant", "Lab Manager",
    "Instructional Designer", "Curriculum Developer", "Education Administrator", "Corporate Trainer"
  ],
  "Construction & Trades": [
    "Construction Worker", "Laborer", "Carpenter", "Framing Carpenter", "Finish Carpenter", "Cabinet Maker",
    "Electrician", "Journeyman Electrician", "Master Electrician", "Lineman",
    "Plumber", "Pipefitter", "Steamfitter", "Sprinkler Fitter",
    "HVAC Technician", "Elevator Mechanic", "Roofer", "Glazier", "Painter",
    "Drywall Installer", "Flooring Installer", "Tile Setter", "Mason", "Bricklayer", "Cement Mason", "Stonemason",
    "Welder", "Ironworker", "Boilermaker", "Millwright", "Sheet Metal Worker",
    "Heavy Equipment Operator", "Crane Operator", "Bulldozer Operator", "Excavator Operator",
    "Construction Manager", "Site Superintendent", "Foreman", "General Contractor",
    "Estimator", "Safety Officer", "Building Inspector", "Landscaper", "Arborist", "Solar Installer"
  ],
  "Manufacturing & Logistics": [
    "Production Associate", "Assembler", "Machine Operator", "CNC Machinist", "Tool and Die Maker",
    "Welder", "Quality Control Inspector", "Safety Coordinator", "Plant Manager", "Production Manager",
    "Warehouse Associate", "Forklift Operator", "Material Handler", "Picker/Packer",
    "Shipping and Receiving Clerk", "Inventory Specialist", "Warehouse Manager",
    "Truck Driver (CDL)", "Delivery Driver", "Courier", "Dispatcher", "Fleet Manager",
    "Logistics Coordinator", "Logistics Manager", "Supply Chain Analyst", "Supply Chain Manager",
    "Procurement Manager", "Purchasing Agent", "Buyer", "Operations Manager"
  ],
  "Legal": [
    "Lawyer", "Attorney", "Associate Attorney", "Partner", "General Counsel", "Corporate Counsel",
    "Litigator", "Public Defender", "Prosecutor", "District Attorney", "Judge", "Magistrate",
    "Law Clerk", "Court Reporter", "Mediator", "Arbitrator",
    "Paralegal", "Legal Assistant", "Legal Secretary",
    "Compliance Officer", "Contract Administrator", "Patent Agent", "Intellectual Property Lawyer"
  ],
  "Hospitality & Tourism": [
    "Hotel Manager", "Front Desk Agent", "Concierge", "Housekeeper", "Housekeeping Manager",
    "Restaurant Manager", "Executive Chef", "Sous Chef", "Line Cook", "Prep Cook", "Pastry Chef",
    "Server", "Bartender", "Barista", "Host/Hostess", "Dishwasher", "Sommelier", "Mixologist",
    "Event Planner", "Wedding Planner", "Catering Manager", "Banquet Manager",
    "Travel Agent", "Tour Guide", "Flight Attendant", "Pilot", "Cruise Ship Director",
    "Casino Manager", "Gaming Dealer", "Spa Manager", "Resort Manager"
  ],
  "Science": [
    "Biologist", "Microbiologist", "Molecular Biologist", "Geneticist", "Marine Biologist", "Zoologist", "Botanist",
    "Chemist", "Biochemist", "Analytical Chemist", "Organic Chemist", "Pharmacologist",
    "Physicist", "Astronomer", "Astrophysicist",
    "Geologist", "Meteorologist", "Ecologist", "Environmental Scientist", "Hydrologist",
    "Epidemiologist", "Forensic Scientist", "Agricultural Scientist", "Food Scientist",
    "Lab Technician", "Lab Manager", "Clinical Research Coordinator", "Research Scientist"
  ]
};

const COUNTRIES = [
  "FINLAND",
  "SWEDEN",
  "NETHERLANDS",
  "GERMANY",
  "ITALY",
  "FRANCE",
  "POLAND",
  "CZECHIA",
  "LATVIA",
  "CROATIA",
  "SLOVAKIA",
  "MACEDONIA",
  "SERBIA",
  "ALBANIA",
  "BELARUS",
  "MONTENEGRO"
];

const INITIAL_DATA = {
  cvType: 'experienced',
  personal: {
    firstName: '',
    surname: '',
    title: '',
    email: '',
    phone: '',
    whatsapp: '',
    alternativePhone: '',
    country: '',
    state: '',
    postalAddress: '',
    pinCode: '',
    nationality: '',
    stateLocation: '',
    placeOfIssue: '',
    passportNumber: '',
    passportExpiry: '',
    dob: '',
    placeOfBirth: '',
    gender: '',
    maritalStatus: '',
    linkedin: '',
    facebook: '',
    instagram: '',
    website: '',
    photo: null,
    summary: ''
  },
  jobApply: {
    applyingCountry: '',
    applyingPost: ''
  },
  coverLetter: {
    companyName: "",
    recipient: "",
    jobDescription: "",
    content: ""
  },
  experience: [
    {
      id: 1,
      role: '',
      company: '',
      website: '',
      location: '',
      start: '',
      end: '',
      description: ''
    }
  ],
  education: [
    {
      id: 1,
      degree: '',
      school: '',
      website: '',
      year: '',
      category: 'Academic',
      cgpa: '',
      coursework: ''
    }
  ],
  skills: [],
  hobbies: [],
  languages: [
    { id: 1, name: '', read: 'Intermediate', write: 'Intermediate', speak: 'Intermediate' }
  ],
  theme: {
    color: '#2563eb',
    font: 'font-sans'
  }
};

// --- Reusable Components (Styled) ---

const InputField = ({ label, value, onChange, placeholder, type = "text", className = "" }) => (
  <div className={`mb-5 ${className}`}>
    <label className="block text-xs font-bold text-gray-900 uppercase tracking-tight mb-2 ml-1">{label}</label>
    <div className="relative group">
      <input
        type={type}
        value={value || ''}
        onChange={e => onChange(e.target.value)}
        placeholder={placeholder}
        className="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-lg text-sm text-gray-900 placeholder-gray-400 font-medium focus:outline-none focus:border-black focus:ring-0 transition-colors shadow-sm"
      />
    </div>
  </div>
);

// --- NEW: DateInput Component with Creative Calendar Styling ---
const DateInput = ({ label, value, onChange, type = "date" }) => (
  <div className="mb-5">
    <label className="block text-xs font-bold text-gray-900 uppercase tracking-tight mb-2 ml-1">{label}</label>
    <div className="relative group">
      <input
        type={type}
        value={value || ''}
        onChange={e => onChange(e.target.value)}
        className="w-full pl-12 pr-4 py-3 bg-white border-2 border-gray-200 rounded-xl text-sm text-gray-900 font-medium focus:outline-none focus:border-black focus:ring-0 transition-colors shadow-sm appearance-none cursor-pointer"
        style={{ colorScheme: 'light' }}
      />
      <div className="absolute left-4 top-3.5 text-blue-600 pointer-events-none group-focus-within:scale-110 transition-transform duration-200">
        <Calendar size={20} strokeWidth={2.5} />
      </div>
      {/* Decorative background for icon area */}
      <div className="absolute left-0 top-0 bottom-0 w-12 bg-blue-50 rounded-l-xl border-r-2 border-gray-100 pointer-events-none -z-10 group-hover:bg-blue-100 transition-colors"></div>
    </div>
  </div>
);

const TextArea = ({ label, value, onChange, placeholder, rows = 4 }) => (
  <div className="mb-5">
    <label className="block text-xs font-bold text-gray-900 uppercase tracking-tight mb-2 ml-1">{label}</label>
    <textarea
      value={value || ''}
      onChange={e => onChange(e.target.value)}
      rows={rows}
      placeholder={placeholder}
      className="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-lg text-sm text-gray-900 placeholder-gray-400 font-medium focus:outline-none focus:border-black focus:ring-0 transition-colors resize-none shadow-sm"
    />
  </div>
);

const Select = ({ label, value, onChange, options, placeholder = "Select an option..." }) => (
  <div className="mb-5">
    <label className="block text-xs font-bold text-gray-900 uppercase tracking-tight mb-2 ml-1">{label}</label>
    <div className="relative">
      <select
        value={value || ""}
        onChange={e => onChange(e.target.value)}
        className={`w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-lg text-sm font-medium appearance-none focus:outline-none focus:border-black focus:ring-0 transition-colors shadow-sm ${!value ? 'text-gray-400' : 'text-gray-900'}`}
      >
        <option value="" disabled>{placeholder}</option>
        {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
      </select>
      <ChevronDown size={20} strokeWidth={2.5} className="absolute right-4 top-3.5 text-gray-900 pointer-events-none" />
    </div>
  </div>
);

// --- RICH TEXT EDITOR COMPONENT ---
const RichEditor = ({ value, onChange, placeholder }) => {
  const contentEditableRef = useRef(null);

  const execCmd = (command, value = null) => {
    document.execCommand(command, false, value);
    if (contentEditableRef.current) {
      contentEditableRef.current.focus(); 
      handleChange(); 
    }
  };

  const handleChange = () => {
    if (contentEditableRef.current && onChange) {
      onChange(contentEditableRef.current.innerHTML);
    }
  };

  useEffect(() => {
    if (contentEditableRef.current && contentEditableRef.current.innerHTML !== value) {
      if (!contentEditableRef.current.innerText.trim() && value) {
         contentEditableRef.current.innerHTML = value;
      } else if (value !== contentEditableRef.current.innerHTML) {
         const isFocused = document.activeElement === contentEditableRef.current;
         if (!isFocused) {
            contentEditableRef.current.innerHTML = value;
         }
      }
    }
  }, [value]);

  const ToolbarBtn = ({ icon: Icon, cmd, arg, title }) => (
    <button
      type="button"
      onMouseDown={(e) => {
        e.preventDefault(); 
        execCmd(cmd, arg);
      }}
      className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
      title={title}
    >
      <Icon size={16} strokeWidth={2.5} />
    </button>
  );

  return (
    <div className="border-2 border-gray-200 rounded-lg overflow-hidden bg-white shadow-sm focus-within:border-black transition-colors">
      <div className="flex flex-wrap items-center gap-1 p-2 bg-gray-50 border-b-2 border-gray-100">
        <ToolbarBtn icon={Bold} cmd="bold" title="Bold" />
        <ToolbarBtn icon={Italic} cmd="italic" title="Italic" />
        <ToolbarBtn icon={Underline} cmd="underline" title="Underline" />
        <div className="w-0.5 h-5 bg-gray-300 mx-2"></div>
        <ToolbarBtn icon={List} cmd="insertUnorderedList" title="Bullet List" />
        <ToolbarBtn icon={ListOrdered} cmd="insertOrderedList" title="Numbered List" />
        <div className="w-0.5 h-5 bg-gray-300 mx-2"></div>
        <ToolbarBtn icon={AlignLeft} cmd="justifyLeft" title="Align Left" />
        <ToolbarBtn icon={AlignCenter} cmd="justifyCenter" title="Align Center" />
        <ToolbarBtn icon={AlignRight} cmd="justifyRight" title="Align Right" />
      </div>
      <div
        ref={contentEditableRef}
        className="p-4 min-h-[140px] max-h-[300px] overflow-y-auto text-sm text-gray-800 font-medium focus:outline-none prose prose-sm max-w-none prose-p:my-1 prose-ul:my-1 prose-li:my-0"
        contentEditable
        onInput={handleChange}
        dangerouslySetInnerHTML={{ __html: value }}
        style={{ whiteSpace: 'pre-wrap' }}
      />
    </div>
  );
};

const SmartTextArea = ({ label, value, onChange, placeholder, rows = 4, onAiClick, onMicClick, isLoading, isListening }) => {
  const [prompt, setPrompt] = useState('');

  return (
    <div className="mb-5">
      <div className="flex justify-between items-center mb-2 ml-1">
        <label className="block text-xs font-bold text-gray-900 uppercase tracking-tight">{label}</label>
        <div className="flex gap-2">
          {onMicClick && (
            <button 
              onClick={onMicClick} 
              className={`flex items-center gap-1.5 px-3 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider border-2 transition-all ${
                isListening 
                  ? 'bg-red-500 border-red-500 text-white animate-pulse' 
                  : 'bg-white text-gray-600 border-gray-200 hover:border-gray-900 hover:text-gray-900'
              }`}
            >
              {isListening ? <StopCircle size={12} strokeWidth={3} /> : <Mic size={12} strokeWidth={3} />}
              {isListening ? 'LISTENING' : 'DICTATE'}
            </button>
          )}
        </div>
      </div>
      
      {onAiClick && (
        <div className="relative mb-3 group">
          <div className="relative flex items-center gap-2 bg-gradient-to-r from-purple-50 to-indigo-50 p-1.5 rounded-lg border-2 border-purple-100 group-hover:border-purple-300 transition-colors">
             <div className="bg-white p-1.5 rounded border border-purple-100 shadow-sm">
                <Wand2 size={16} strokeWidth={2.5} className="text-purple-600" />
             </div>
             <input 
                type="text" 
                value={prompt}
                onChange={(e) => setPrompt(e.target.value)}
                placeholder="Ask AI to improve this section..."
                className="flex-1 bg-transparent border-none text-xs font-medium text-gray-700 placeholder-purple-300 focus:outline-none px-2"
                onKeyDown={(e) => e.key === 'Enter' && onAiClick(prompt)}
             />
             <button 
                onClick={() => onAiClick(prompt)}
                disabled={isLoading}
                className="bg-black text-white p-2 rounded-md hover:bg-gray-800 transition-colors disabled:opacity-50"
             >
                {isLoading ? <Loader size={14} className="animate-spin" /> : <Send size={14} strokeWidth={2.5} />}
             </button>
          </div>
        </div>
      )}

      <RichEditor 
        value={value || ''} 
        onChange={onChange} 
        placeholder={placeholder}
      />
    </div>
  );
};

const SectionHeader = ({ title, icon: Icon, id, isOpen, onClick, colorClass }) => (
  <button
    onClick={onClick}
    className={`w-full flex items-center justify-between p-5 border-b-2 border-gray-100 transition-all duration-200 ${
      isOpen 
        ? 'bg-white' 
        : 'bg-white hover:bg-gray-50'
    }`}
  >
    <div className="flex items-center gap-4">
      <div className={`
        p-3 rounded-xl transition-all duration-200 border-2
        ${isOpen 
          ? 'bg-black border-black text-white shadow-lg' 
          : `bg-white border-gray-200 ${colorClass || 'text-gray-500'} group-hover:border-gray-400`
        }
      `}>
        <Icon size={20} strokeWidth={2.5} />
      </div>
      <span className={`font-bold text-base transition-colors ${isOpen ? 'text-black' : 'text-gray-600'}`}>{title}</span>
    </div>
    <div className={`
      transition-transform duration-300
      ${isOpen ? 'rotate-180 text-black' : 'rotate-0 text-gray-300'}
    `}>
      <ChevronDown size={24} strokeWidth={3} />
    </div>
  </button>
);

// --- IMAGE CROPPER COMPONENT ---
const ImageCropper = ({ imageSrc, onCancel, onSave }) => {
  const [zoom, setZoom] = useState(1);
  const [offset, setOffset] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
  const imgRef = useRef(null);

  // Constants
  const SIZE = 280; // Viewport size

  const handleMouseDown = (e) => {
    setIsDragging(true);
    setDragStart({ x: e.clientX - offset.x, y: e.clientY - offset.y });
  };

  const handleMouseMove = (e) => {
    if (isDragging) {
      setOffset({
        x: e.clientX - dragStart.x,
        y: e.clientY - dragStart.y
      });
    }
  };

  const handleMouseUp = () => setIsDragging(false);

  const handleSave = () => {
    const canvas = document.createElement('canvas');
    canvas.width = 400; // High res output
    canvas.height = 400;
    const ctx = canvas.getContext('2d');
    const img = imgRef.current;
    
    // Output settings
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';

    // Calculate render params
    const scaleFactor = 400 / SIZE; // Ratio between output and preview
    
    // Draw background (optional, usually transparent or white)
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, 400, 400);

    // Initial Image setup Logic matching the CSS "object-fit: cover" simulation
    const aspect = img.naturalWidth / img.naturalHeight;
    let baseWidth, baseHeight;
    
    if (aspect > 1) {
        // Landscape: Height matches SIZE, Width is larger
        baseHeight = SIZE;
        baseWidth = SIZE * aspect;
    } else {
        // Portrait: Width matches SIZE, Height is larger
        baseWidth = SIZE;
        baseHeight = SIZE / aspect;
    }

    const drawWidth = baseWidth * zoom * scaleFactor;
    const drawHeight = baseHeight * zoom * scaleFactor;
    
    // Centering Logic
    const outputCenterX = 200;
    const outputCenterY = 200;
    
    // If offset was (0,0), image center aligns with viewport center
    // base X coordinate (top-left) if perfectly centered
    const baseX = outputCenterX - (drawWidth / 2);
    const baseY = outputCenterY - (drawHeight / 2);
    
    // Apply user offset (scaled)
    // Offset is in "preview pixels", so we scale it up
    const finalX = baseX + (offset.x * scaleFactor);
    const finalY = baseY + (offset.y * scaleFactor);

    // Circular Clip
    ctx.save();
    ctx.beginPath();
    // Square crop for passport
    // ctx.arc(200, 200, 200, 0, Math.PI * 2);
    ctx.rect(0,0,400,400); 
    ctx.closePath();
    ctx.clip();

    ctx.drawImage(img, finalX, finalY, drawWidth, drawHeight);
    ctx.restore();
    
    onSave(canvas.toDataURL('image/png'));
  };

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm flex flex-col gap-6 border-4 border-black">
        <div className="flex justify-between items-center border-b-2 border-gray-100 pb-4">
            <h3 className="font-black text-xl text-black flex items-center gap-2 uppercase tracking-tight"><ImageIcon size={24} strokeWidth={3}/> Edit Photo</h3>
            <button onClick={onCancel} className="p-2 hover:bg-red-50 rounded-full text-gray-400 hover:text-red-500 transition-colors"><X size={24} strokeWidth={3}/></button>
        </div>
        
        {/* Viewport */}
        <div 
            className="relative overflow-hidden bg-gray-100 rounded-sm mx-auto cursor-move ring-4 ring-black shadow-xl group"
            style={{ width: SIZE, height: SIZE }}
            onMouseDown={handleMouseDown}
            onMouseMove={handleMouseMove}
            onMouseUp={handleMouseUp}
            onMouseLeave={handleMouseUp}
            onTouchStart={(e) => {
              const touch = e.touches[0];
              handleMouseDown({ clientX: touch.clientX, clientY: touch.clientY });
            }}
            onTouchMove={(e) => {
              const touch = e.touches[0];
              handleMouseMove({ clientX: touch.clientX, clientY: touch.clientY });
            }}
            onTouchEnd={handleMouseUp}
        >
            <img 
                ref={imgRef}
                src={imageSrc} 
                className="absolute max-w-none origin-center pointer-events-none select-none transition-transform duration-75"
                style={{ 
                    top: '50%', 
                    left: '50%',
                    transform: `translate(-50%, -50%) translate(${offset.x}px, ${offset.y}px) scale(${zoom})`,
                    // Initial sizing logic
                    ...(imgRef.current && imgRef.current.naturalWidth < imgRef.current.naturalHeight 
                        ? { width: '100%', height: 'auto' } 
                        : { height: '100%', width: 'auto' }
                    )
                }}
                onLoad={(e) => {
                   // Force re-render to apply sizing styles based on natural aspect ratio
                   setZoom(current => current); 
                }}
            />
            {/* Grid Overlay on Hover */}
            <div className="absolute inset-0 opacity-0 group-hover:opacity-100 pointer-events-none grid grid-cols-3 grid-rows-3 transition-opacity duration-300">
                 <div className="border-r border-white/50"></div>
                 <div className="border-r border-white/50"></div>
                 <div></div>
                 <div className="border-r border-white/50 border-t"></div>
                 <div className="border-r border-white/50 border-t"></div>
                 <div className="border-t border-white/50"></div>
                 <div className="border-r border-white/50 border-t"></div>
                 <div className="border-r border-white/50 border-t"></div>
                 <div className="border-t border-white/50"></div>
            </div>
        </div>
        
        <div className="space-y-4">
            <div className="flex justify-between text-xs font-black text-gray-400 uppercase tracking-wider">
                <span>Zoom Level</span>
                <span>{Math.round(zoom * 100)}%</span>
            </div>
            <input 
                type="range" 
                min="1" 
                max="3" 
                step="0.05" 
                value={zoom} 
                onChange={(e) => setZoom(parseFloat(e.target.value))}
                className="w-full accent-black h-2 bg-gray-200 rounded-full appearance-none cursor-pointer"
            />
        </div>

        <div className="flex gap-3 pt-2">
            <button onClick={onCancel} className="flex-1 py-3 text-sm font-bold text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">Cancel</button>
            <button onClick={handleSave} className="flex-1 py-3 text-sm font-bold text-white bg-black hover:bg-gray-800 rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg"><Check size={18} strokeWidth={3}/> Save Crop</button>
        </div>
      </div>
    </div>
  );
};

  // --- NEW: Autocomplete Job Selector ---
  // ... (JobSelector component) ...
  // (Adding it back fully to be safe)
  const JobSelector = ({ value, onChange, label = "Job Title" }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [query, setQuery] = useState(value || '');
    const wrapperRef = useRef(null);

    useEffect(() => { setQuery(value || ''); }, [value]);

    const filteredOptions = useMemo(() => {
        if (!query) return JOB_DB;
        const result = {};
        let hasResults = false;
        Object.keys(JOB_DB).forEach(category => {
            const matches = JOB_DB[category].filter(job => job.toLowerCase().includes(query.toLowerCase()));
            if (matches.length > 0) { result[category] = matches; hasResults = true; }
        });
        return hasResults ? result : {}; 
    }, [query]);

    useEffect(() => {
        const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false); };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleSelect = (job) => { setQuery(job); onChange(job); setIsOpen(false); };
    const handleInputChange = (e) => { const val = e.target.value; setQuery(val); onChange(val); setIsOpen(true); };
    const optionsToDisplay = (!query && isOpen) ? JOB_DB : filteredOptions;
    const hasOptions = Object.keys(optionsToDisplay).length > 0;

    return (
        <div className="mb-5" ref={wrapperRef}>
            <div className="flex justify-between items-center mb-2 ml-1">
                <label className="text-xs font-bold text-gray-900 uppercase tracking-tight">{label}</label>
            </div>
            <div className="relative">
                <div className="relative group">
                    <input type="text" value={query} onChange={handleInputChange} onFocus={() => setIsOpen(true)} placeholder={`e.g. Project Manager`} className="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-lg text-sm text-gray-900 placeholder-gray-400 font-medium focus:outline-none focus:border-black focus:ring-0 transition-all shadow-sm" />
                    <ChevronDown size={20} strokeWidth={2.5} className={`absolute right-4 top-3.5 text-gray-900 pointer-events-none transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
                </div>
                {isOpen && hasOptions && (
                    <div className="absolute z-50 w-full mt-2 bg-white border-2 border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto custom-scroll animate-in fade-in zoom-in-95 duration-100">
                        {Object.entries(optionsToDisplay).map(([category, jobs]) => (
                            <div key={category}>
                                <div className="px-4 py-2 text-[10px] font-black text-gray-400 uppercase tracking-widest bg-gray-50 sticky top-0 border-b border-gray-100">{category}</div>
                                {jobs.map(job => (
                                    <button key={job} onClick={() => handleSelect(job)} className="w-full text-left px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-black hover:text-white transition-colors">{job}</button>
                                ))}
                            </div>
                        ))}
                    </div>
                )}
                 {isOpen && query && !hasOptions && (
                    <div className="absolute z-50 w-full mt-2 bg-white border-2 border-gray-200 rounded-xl shadow-xl p-4 text-center">
                        <p className="text-sm text-gray-500 font-medium">No matching roles found.</p>
                        <button onClick={() => setIsOpen(false)} className="mt-2 text-xs font-bold text-blue-600 hover:underline">Use "{query}"</button>
                    </div>
                )}
            </div>
        </div>
    );
  };

  const Editor = ({ cvData, update, updateArrayItem, removeItem, addItem, handleImageUpload, handleAiAssist, aiLoading, toggleDictation, listening, listeningTarget, expandedSection, setExpandedSection, JOB_DB }) => {
    const [skillsPrompt, setSkillsPrompt] = useState('');

    return (
    <div className="h-full flex flex-col bg-[#f8f9fc] bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px]">
      <div className="p-4 border-b-2 border-gray-200 bg-white/90 backdrop-blur-xl sticky top-0 z-10 flex items-center justify-between shadow-sm no-print">
        <h2 className="text-xl font-black text-black flex items-center gap-3 tracking-tight">
          <div className="bg-black p-2 rounded-lg text-white shadow-lg"><PenTool size={20} strokeWidth={2.5} /></div> 
          <span>EDITOR</span>
        </h2>
        {/* CV Type Toggle */}
        <div className="flex bg-gray-100 p-1.5 rounded-xl border-2 border-gray-200">
          <button 
            onClick={() => update('cvType', 'experienced')}
            className={`px-5 py-2 text-xs font-bold uppercase tracking-wide rounded-lg transition-all ${cvData.cvType === 'experienced' ? 'bg-white shadow-md text-black ring-1 ring-black/5' : 'text-gray-500 hover:text-gray-900'}`}
          >
            Experienced
          </button>
          <button 
            onClick={() => update('cvType', 'fresher')}
            className={`px-5 py-2 text-xs font-bold uppercase tracking-wide rounded-lg transition-all ${cvData.cvType === 'fresher' ? 'bg-white shadow-md text-green-600 ring-1 ring-black/5' : 'text-gray-500 hover:text-gray-900'}`}
          >
            Fresher
          </button>
        </div>
      </div>

      <div className="flex-1 overflow-y-auto custom-scroll">
        <div className="max-w-3xl p-6 md:p-10 pb-32">
        
        {/* --- JOB APPLY SECTION --- */}
        <div className="bg-white rounded-2xl mb-8 overflow-hidden shadow-xl border-2 border-gray-100">
          <SectionHeader title="Job Apply Details" icon={BriefcaseIcon} id="jobApply" isOpen={expandedSection === 'jobApply'} onClick={() => setExpandedSection(expandedSection === 'jobApply' ? null : 'jobApply')} colorClass="text-orange-500" />
          {expandedSection === 'jobApply' && (
             <div className="p-8 pt-4 animate-in slide-in-from-top-4 space-y-6">
                <Select label="Applying Country" value={cvData.jobApply?.applyingCountry} onChange={v => update('jobApply.applyingCountry', v)} options={COUNTRIES} />
                <InputField label="Post for Applying" value={cvData.jobApply?.applyingPost} onChange={v => update('jobApply.applyingPost', v)} placeholder="e.g. Senior Developer" />
             </div>
          )}
        </div>

        <div className="bg-white rounded-2xl mb-8 overflow-hidden shadow-xl border-2 border-gray-100">
          <SectionHeader title="Personal Information" icon={User} id="personal" isOpen={expandedSection === 'personal'} onClick={() => setExpandedSection(expandedSection === 'personal' ? null : 'personal')} colorClass="text-blue-600" />
          {expandedSection === 'personal' && (
            <div className="p-8 pt-4 animate-in slide-in-from-top-4 space-y-6">
              <div className="flex items-center gap-6 mb-8 bg-gray-50 p-6 rounded-2xl border-2 border-gray-100 border-dashed">
                <div className="relative group">
                   <div className="w-24 h-24 bg-white overflow-hidden flex-shrink-0 border-4 border-white shadow-lg ring-1 ring-black/5">
                    {cvData.personal.photo ? <img src={cvData.personal.photo} alt="Profile" className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-gray-300 bg-gray-100"><User size={40} strokeWidth={1.5} /></div>}
                  </div>
                  <button className="absolute bottom-0 right-0 bg-black text-white p-2 rounded-full shadow-xl border-2 border-white hover:scale-110 transition-transform">
                      <Camera size={14} strokeWidth={2.5} />
                      <input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleImageUpload} />
                  </button>
                </div>
                <div className="flex-1">
                  <h3 className="text-base font-bold text-gray-900 mb-1">Passport Photo</h3>
                  <p className="text-xs font-medium text-gray-500 mb-3">Upload a passport-size photo (approx 45mm x 35mm).</p>
                  {cvData.personal.photo && <button onClick={() => update('personal.photo', null)} className="text-[10px] font-bold uppercase tracking-wide text-red-500 flex items-center gap-1 hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors"><Trash2 size={12} strokeWidth={2.5} /> Remove photo</button>}
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InputField label="First Name" value={cvData.personal.firstName} onChange={v => update('personal.firstName', v)} />
                <InputField label="Surname" value={cvData.personal.surname} onChange={v => update('personal.surname', v)} />
              </div>
              <JobSelector value={cvData.personal.title} onChange={v => update('personal.title', v)} />
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InputField label="Email" value={cvData.personal.email} onChange={v => update('personal.email', v)} />
                <InputField label="Phone" value={cvData.personal.phone} onChange={v => update('personal.phone', v)} />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InputField label="WhatsApp" value={cvData.personal.whatsapp} onChange={v => update('personal.whatsapp', v)} />
                <InputField label="Alt Phone" value={cvData.personal.alternativePhone} onChange={v => update('personal.alternativePhone', v)} />
              </div>

              <div className="mt-6 mb-3 flex items-center gap-2">
                <div className="h-px bg-gray-200 flex-1"></div>
                <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Address Details</span>
                <div className="h-px bg-gray-200 flex-1"></div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InputField label="Country" value={cvData.personal.country} onChange={v => update('personal.country', v)} />
                <InputField label="State" value={cvData.personal.state} onChange={v => update('personal.state', v)} />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InputField label="Pin / Zip Code" value={cvData.personal.pinCode} onChange={v => update('personal.pinCode', v)} />
              </div>
              <TextArea label="Postal Address" value={cvData.personal.postalAddress} onChange={v => update('personal.postalAddress', v)} rows={2} />

              <div className="mt-6 mb-3 flex items-center gap-2">
                <div className="h-px bg-gray-200 flex-1"></div>
                <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Passport & Personal Details</span>
                <div className="h-px bg-gray-200 flex-1"></div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <DateInput label="Date of Birth" value={cvData.personal.dob} onChange={v => update('personal.dob', v)} />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InputField label="Nationality" value={cvData.personal.nationality} onChange={v => update('personal.nationality', v)} />
                <InputField label="State / Location (Birth)" value={cvData.personal.stateLocation} onChange={v => update('personal.stateLocation', v)} />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Select label="Gender" value={cvData.personal.gender} onChange={v => update('personal.gender', v)} options={["Male", "Female", "Non-Binary", "Prefer not to say"]} />
                <Select label="Marital Status" value={cvData.personal.maritalStatus} onChange={v => update('personal.maritalStatus', v)} options={["Single", "Married", "Divorced", "Widowed"]} />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <InputField label="Passport No." value={cvData.personal.passportNumber} onChange={v => update('personal.passportNumber', v)} />
                <InputField label="Place of Issue" value={cvData.personal.placeOfIssue} onChange={v => update('personal.placeOfIssue', v)} />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <DateInput label="Passport Expiry" value={cvData.personal.passportExpiry} onChange={v => update('personal.passportExpiry', v)} />
              </div>
              <InputField label="Website / Portfolio" value={cvData.personal.website} onChange={v => update('personal.website', v)} />
              
              <div className="pt-6 border-t-2 border-gray-100">
                <label className="block text-xs font-bold text-gray-900 uppercase tracking-tight mb-4">Social Profiles</label>
                <div className="space-y-4">
                  <div className="flex items-center gap-3 bg-gray-50 p-2.5 rounded-xl border-2 border-gray-100 focus-within:border-blue-300 transition-colors">
                    <div className="p-2 bg-white rounded-lg shadow-sm border border-gray-100"><Linkedin size={20} className="text-blue-700" strokeWidth={2} /></div>
                    <input type="text" placeholder="LinkedIn URL" className="flex-1 bg-transparent text-sm font-medium outline-none placeholder-gray-400 text-gray-800" value={cvData.personal.linkedin} onChange={e => update('personal.linkedin', e.target.value)} />
                  </div>
                  <div className="flex items-center gap-3 bg-gray-50 p-2.5 rounded-xl border-2 border-gray-100 focus-within:border-blue-300 transition-colors">
                    <div className="p-2 bg-white rounded-lg shadow-sm border border-gray-100"><Facebook size={20} className="text-blue-600" strokeWidth={2} /></div>
                    <input type="text" placeholder="Facebook URL" className="flex-1 bg-transparent text-sm font-medium outline-none placeholder-gray-400 text-gray-800" value={cvData.personal.facebook} onChange={e => update('personal.facebook', e.target.value)} />
                  </div>
                  <div className="flex items-center gap-3 bg-gray-50 p-2.5 rounded-xl border-2 border-gray-100 focus-within:border-pink-300 transition-colors">
                    <div className="p-2 bg-white rounded-lg shadow-sm border border-gray-100"><Instagram size={20} className="text-pink-600" strokeWidth={2} /></div>
                    <input type="text" placeholder="Instagram URL" className="flex-1 bg-transparent text-sm font-medium outline-none placeholder-gray-400 text-gray-800" value={cvData.personal.instagram} onChange={e => update('personal.instagram', e.target.value)} />
                  </div>
                </div>
              </div>

              <div className="mt-8">
                <SmartTextArea label="Professional Summary" value={cvData.personal.summary} onChange={v => update('personal.summary', v)} onAiClick={(prompt) => handleAiAssist('summary', null, prompt)} onMicClick={() => toggleDictation('summary')} isLoading={aiLoading === 'summary'} isListening={listeningTarget?.type === 'summary' && listening} />
              </div>
            </div>
          )}
        </div>

        {/* ... (Experience, Education, Skills, Languages, CoverLetter, Theme sections - Same as before, just collapsed for brevity) ... */}
        {/* I am ensuring all components from previous code are included here implicitly by context or explicitly if changed */}
        {cvData.cvType !== 'fresher' && (
          <div className="bg-white rounded-2xl mb-8 overflow-hidden shadow-xl border-2 border-gray-100">
            <SectionHeader title="Work Experience" icon={Briefcase} id="experience" isOpen={expandedSection === 'experience'} onClick={() => setExpandedSection(expandedSection === 'experience' ? null : 'experience')} colorClass="text-purple-600" />
            {expandedSection === 'experience' && (
              <div className="p-8 pt-4 bg-gray-50/30 space-y-6 animate-in slide-in-from-top-4">
                {cvData.experience.map(exp => (
                  <div key={exp.id} className="bg-white p-6 rounded-2xl shadow-sm border-2 border-gray-200 relative group transition-all hover:border-blue-200 hover:shadow-md">
                    <button onClick={() => removeItem('experience', exp.id)} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 p-2 hover:bg-red-50 rounded-xl transition-colors"><Trash2 size={18} strokeWidth={2.5} /></button>
                    <div className="grid gap-4">
                      <JobSelector label="Role" value={exp.role} onChange={v => updateArrayItem('experience', exp.id, 'role', v)} />
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <InputField label="Company" value={exp.company} onChange={v => updateArrayItem('experience', exp.id, 'company', v)} />
                         <InputField label="Location" value={exp.location} onChange={v => updateArrayItem('experience', exp.id, 'location', v)} />
                      </div>
                      <InputField label="Company Website" value={exp.website} onChange={v => updateArrayItem('experience', exp.id, 'website', v)} />
                      <div className="grid grid-cols-2 gap-6">
                        <DateInput label="Start Date" type="month" value={exp.start} onChange={v => updateArrayItem('experience', exp.id, 'start', v)} />
                        <InputField label="End Date" type="text" placeholder="Present or YYYY-MM" value={exp.end} onChange={v => updateArrayItem('experience', exp.id, 'end', v)} />
                      </div>
                      <SmartTextArea label="Responsibilities" value={exp.description} onChange={v => updateArrayItem('experience', exp.id, 'description', v)} rows={4} onAiClick={(prompt) => handleAiAssist('exp', exp.id, prompt)} onMicClick={() => toggleDictation('exp', exp.id)} isLoading={aiLoading === `exp-${exp.id}`} isListening={listeningTarget?.type === 'exp' && listeningTarget?.id === exp.id && listening} />
                    </div>
                  </div>
                ))}
                <button onClick={() => addItem('experience')} className="w-full py-4 flex items-center justify-center gap-3 border-2 border-dashed border-gray-300 rounded-2xl text-sm font-black uppercase tracking-wide text-gray-500 hover:border-black hover:text-black hover:bg-white transition-all"><Plus size={18} strokeWidth={3} /> Add Position</button>
              </div>
            )}
          </div>
        )}

        <div className="bg-white rounded-2xl mb-8 overflow-hidden shadow-xl border-2 border-gray-100">
          <SectionHeader title="Education" icon={GraduationCap} id="education" isOpen={expandedSection === 'education'} onClick={() => setExpandedSection(expandedSection === 'education' ? null : 'education')} colorClass="text-emerald-600" />
          {expandedSection === 'education' && (
            <div className="p-8 pt-4 bg-gray-50/30 space-y-6 animate-in slide-in-from-top-4">
              {cvData.education.map(edu => (
                <div key={edu.id} className="bg-white p-6 rounded-2xl shadow-sm border-2 border-gray-200 relative group hover:border-blue-200 transition-all hover:shadow-md">
                   <button onClick={() => removeItem('education', edu.id)} className="absolute top-4 right-4 text-gray-400 hover:text-red-500 p-2 hover:bg-red-50 rounded-xl transition-colors"><Trash2 size={18} strokeWidth={2.5} /></button>
                   <div className="grid gap-4">
                      <Select label="Category" value={edu.category} onChange={v => updateArrayItem('education', edu.id, 'category', v)} options={["Academic", "Technical", "Certification"]} />
                      <InputField label="Degree / Certificate" value={edu.degree} onChange={v => updateArrayItem('education', edu.id, 'degree', v)} />
                      <InputField label="School / University" value={edu.school} onChange={v => updateArrayItem('education', edu.id, 'school', v)} />
                      <div className="grid grid-cols-2 gap-6">
                        <DateInput label="Completion Date" type="month" value={edu.year} onChange={v => updateArrayItem('education', edu.id, 'year', v)} />
                        <InputField label="Website" value={edu.website} onChange={v => updateArrayItem('education', edu.id, 'website', v)} />
                      </div>
                      {cvData.cvType === 'fresher' && (
                        <div className="pt-4 border-t-2 border-gray-100 grid gap-6">
                           <InputField label="CGPA / Grade" value={edu.cgpa} onChange={v => updateArrayItem('education', edu.id, 'cgpa', v)} />
                           <InputField label="Relevant Coursework" value={edu.coursework} onChange={v => updateArrayItem('education', edu.id, 'coursework', v)} />
                        </div>
                      )}
                   </div>
                </div>
              ))}
              <button onClick={() => addItem('education')} className="w-full py-4 flex items-center justify-center gap-3 border-2 border-dashed border-gray-300 rounded-2xl text-sm font-black uppercase tracking-wide text-gray-500 hover:border-black hover:text-black hover:bg-white transition-all"><Plus size={18} strokeWidth={3} /> Add Education</button>
            </div>
          )}
        </div>

        <div className="bg-white rounded-2xl mb-8 overflow-hidden shadow-xl border-2 border-gray-100">
          <SectionHeader title="Skills & Interests" icon={Sparkles} id="skills" isOpen={expandedSection === 'skills'} onClick={() => setExpandedSection(expandedSection === 'skills' ? null : 'skills')} colorClass="text-amber-500" />
          {expandedSection === 'skills' && (
            <div className="p-8 pt-4 space-y-6 animate-in slide-in-from-top-4">
              <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-2xl border-2 border-indigo-100 shadow-inner">
                 <div className="flex justify-between items-center mb-4">
                    <span className="text-xs font-black text-indigo-900 flex items-center gap-2 uppercase tracking-widest"><Wand2 size={16} strokeWidth={2.5}/> AI Skill Suggester</span>
                 </div>
                 <div className="flex items-center gap-3 mb-2 bg-white p-2 rounded-xl shadow-sm border border-indigo-100">
                     <input type="text" value={skillsPrompt} onChange={(e) => setSkillsPrompt(e.target.value)} placeholder="e.g. 'Java Developer'" className="flex-1 text-sm p-2 rounded-lg outline-none text-gray-800 placeholder-gray-400 bg-transparent font-medium" />
                     <button onClick={() => handleAiAssist('skills', null, skillsPrompt)} disabled={aiLoading === 'skills'} className="text-xs bg-black text-white px-4 py-2.5 rounded-lg font-bold hover:bg-gray-800 transition-colors shadow-lg">
                      {aiLoading === 'skills' ? <Loader size={14} className="animate-spin" /> : 'SUGGEST'}
                    </button>
                 </div>
              </div>
              <TextArea label="Technical Skills (Comma Separated)" value={cvData.skills.join(', ')} onChange={v => update('skills', v.split(',').map(s => s.trim()))} rows={3} placeholder="Java, Python, React..." />
              <TextArea label="Hobbies & Interests (Comma Separated)" value={(cvData.hobbies || []).join(', ')} onChange={v => update('hobbies', v.split(',').map(s => s.trim()))} rows={2} placeholder="Reading, Hiking..." />
            </div>
          )}
        </div>

        <div className="bg-white rounded-2xl mb-8 overflow-hidden shadow-xl border-2 border-gray-100">
          <SectionHeader title="Languages" icon={Globe} id="languages" isOpen={expandedSection === 'languages'} onClick={() => setExpandedSection(expandedSection === 'languages' ? null : 'languages')} colorClass="text-cyan-500" />
          {expandedSection === 'languages' && (
            <div className="p-8 pt-4 bg-gray-50/30 space-y-4 animate-in slide-in-from-top-4">
              {(cvData.languages || []).map(lang => (
                <div key={lang.id} className="bg-white p-5 rounded-2xl border-2 border-gray-200 relative shadow-sm hover:border-blue-200 transition-colors">
                   <button onClick={() => removeItem('languages', lang.id)} className="absolute top-4 right-4 text-gray-300 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors"><Trash2 size={16} strokeWidth={2.5} /></button>
                   <InputField label="Language Name" value={lang.name} onChange={v => updateArrayItem('languages', lang.id, 'name', v)} className="mb-4" />
                   <div className="grid grid-cols-3 gap-3">
                      <Select label="Speak" value={lang.speak} onChange={v => updateArrayItem('languages', lang.id, 'speak', v)} options={['Native', 'Fluent', 'Intermediate', 'Beginner']} />
                      <Select label="Read" value={lang.read} onChange={v => updateArrayItem('languages', lang.id, 'read', v)} options={['Native', 'Fluent', 'Intermediate', 'Beginner']} />
                      <Select label="Write" value={lang.write} onChange={v => updateArrayItem('languages', lang.id, 'write', v)} options={['Native', 'Fluent', 'Intermediate', 'Beginner']} />
                   </div>
                </div>
              ))}
               <button onClick={() => addItem('languages')} className="w-full py-4 flex items-center justify-center gap-3 border-2 border-dashed border-gray-300 rounded-2xl text-sm font-black uppercase tracking-wide text-gray-500 hover:border-black hover:text-black hover:bg-white transition-all"><Plus size={18} strokeWidth={3} /> Add Language</button>
            </div>
          )}
        </div>

        <div className="bg-white rounded-2xl mb-8 overflow-hidden shadow-xl border-2 border-gray-100">
           <SectionHeader title="Cover Letter" icon={FileText} id="coverLetter" isOpen={expandedSection === 'coverLetter'} onClick={() => setExpandedSection(expandedSection === 'coverLetter' ? null : 'coverLetter')} colorClass="text-rose-500" />
           {expandedSection === 'coverLetter' && (
             <div className="p-8 pt-4 space-y-6 animate-in slide-in-from-top-4">
               <div className="bg-gradient-to-br from-purple-50 to-blue-50 p-6 rounded-2xl border-2 border-purple-100 shadow-sm relative overflow-hidden">
                 <div className="absolute top-0 right-0 w-40 h-40 bg-purple-200 rounded-full blur-3xl opacity-20 -mr-20 -mt-20 pointer-events-none"></div>
                 <h4 className="text-xs font-black text-purple-900 flex items-center gap-2 mb-4 uppercase tracking-widest"><Wand2 size={16} strokeWidth={2.5}/> AI Writer</h4>
                 <div className="space-y-4 relative z-10">
                   <div className="grid grid-cols-2 gap-6">
                      <InputField label="Company Name" value={cvData.coverLetter.companyName} onChange={v => update('coverLetter.companyName', v)} className="mb-0" />
                      <InputField label="Recipient" value={cvData.coverLetter.recipient} onChange={v => update('coverLetter.recipient', v)} className="mb-0" />
                   </div>
                   <SmartTextArea label="Job Description Context" value={cvData.coverLetter.jobDescription} onChange={v => update('coverLetter.jobDescription', v)} rows={2} placeholder="Paste JD or ask AI specifically e.g., 'Write for a startup'..." onAiClick={(prompt) => handleAiAssist('cover-letter', null, prompt)} isLoading={aiLoading === 'cover-letter'} />
                 </div>
               </div>
               <SmartTextArea label="Letter Content" value={cvData.coverLetter.content} onChange={v => update('coverLetter.content', v)} rows={12} />
             </div>
           )}
        </div>

        <div className="bg-white rounded-2xl mb-8 overflow-hidden shadow-xl border-2 border-gray-100">
           <SectionHeader title="Design & Theme" icon={Palette} id="theme" isOpen={expandedSection === 'theme'} onClick={() => setExpandedSection(expandedSection === 'theme' ? null : 'theme')} colorClass="text-fuchsia-500" />
           {expandedSection === 'theme' && (
             <div className="p-8 pt-4 animate-in slide-in-from-top-4">
                <label className="block text-xs font-bold text-gray-900 uppercase tracking-tight mb-4">Accent Color</label>
                <div className="flex flex-wrap gap-5">
                   {['#2563eb', '#059669', '#dc2626', '#d97706', '#7c3aed', '#db2777', '#111827'].map(c => (
                     <button key={c} onClick={() => update('theme.color', c)} className={`w-12 h-12 rounded-full transition-all duration-200 hover:scale-110 shadow-sm border-4 border-white ${cvData.theme.color === c ? 'scale-110 ring-4 ring-gray-200 shadow-xl' : 'ring-1 ring-black/5'}`} style={{ backgroundColor: c }} />
                   ))}
                </div>
             </div>
           )}
        </div>
        </div>
      </div>
    </div>
  );
  };

  // --- PREVIEW COMPONENT ---
  const Preview = ({ cvData, expandedSection }) => {
     const p = cvData?.personal || {};
     const jobApply = cvData?.jobApply || {};
     const theme = cvData?.theme?.color || '#000';
     const fullName = `${p.firstName || ''} ${p.surname || ''}`.trim();
     const fullLocation = [p.state, p.country].filter(Boolean).join(', ');

     const calculateAge = (dob) => {
        if (!dob) return null;
        const diff = Date.now() - new Date(dob).getTime();
        const ageDate = new Date(diff); 
        const age = Math.abs(ageDate.getUTCFullYear() - 1970);
        return isNaN(age) ? null : age;
     };

     const age = calculateAge(p.dob);

     // Styles for Rich Text Content in Preview
     const richTextStyle = `
       .rich-text-content ul { list-style-type: disc; padding-left: 1.25rem; margin-bottom: 0.25rem; }
       .rich-text-content ol { list-style-type: decimal; padding-left: 1.25rem; margin-bottom: 0.25rem; }
       .rich-text-content li { margin-bottom: 0.1rem; }
       .rich-text-content p { margin-bottom: 0.25rem; }
       .rich-text-content strong, .rich-text-content b { font-weight: 700; }
       .rich-text-content em, .rich-text-content i { font-style: italic; }
       .rich-text-content u { text-decoration: underline; }
     `;

    // --- REVISED PRINT & PAGE STYLES ---
    const globalStyles = `
        @media print {
            @page {
                size: A4;
                margin: 0; /* Important: Browser adds its own if not 0 */
            }
            
            body {
                margin: 0;
                padding: 0;
                background-color: white;
            }

            /* Hide strictly UI elements */
            .no-print, nav, .editor-panel, .resizer-handle, .zoom-controls { 
                display: none !important; 
            }

            /* Main Layout Reset - Critical for Chrome/Safari */
            .min-h-screen, main, .flex-col {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
                position: static !important;
                width: auto !important;
            }

            /* Print Container takes full width/height */
            .print-container {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 210mm !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                z-index: 9999;
                display: block !important;
                overflow: visible !important;
            }
            
            /* Page wrapper resets */
            .a4-preview-wrapper {
                transform: none !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
            }

            /* Actual content styling for print */
            .preview-page {
                width: 210mm !important;
                min-height: 297mm !important;
                padding: 2.54cm !important; /* Standard 1 inch margin */
                background: white !important;
                margin: 0 !important;
                box-shadow: none !important;
                border: none !important;
                page-break-after: always;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .preview-page:last-child {
                page-break-after: auto;
            }
            
            /* Ensure layout grids work in print */
            .grid {
                display: grid !important;
            }
            
            .flex {
                display: flex !important;
            }
        }
        
        /* Screen Styles */
        .preview-page {
            width: 210mm;
            min-height: 297mm;
            padding: 2.54cm; /* Standard 1 inch margin */
            background: white;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
     `;

     // Cover Letter Render
     if (expandedSection === 'coverLetter') {
       return (
         <div id="cv-pdf-content" className="preview-page print-page text-gray-800 font-sans">
           <style>{richTextStyle}</style>
           <style>{globalStyles}</style>
           <div className="border-b-4 pb-6 mb-8" style={{ borderColor: theme }}>
              <h1 className="text-4xl font-bold uppercase tracking-tight text-gray-900" style={{ color: theme }}>{fullName}</h1>
              <p className="text-xl text-gray-600 font-medium mt-2">{p.title}</p>
              <div className="flex gap-4 text-xs text-gray-500 mt-4"><span>{p.email}</span>  <span>{p.phone}</span>  <span>{fullLocation}</span></div>
           </div>
           <div className="mb-8 font-bold text-sm text-gray-800">{new Date().toLocaleDateString()}</div>
           <div className="mb-8">
             <p className="font-bold text-gray-900">{cvData.coverLetter?.recipient}</p>
             <p className="font-medium text-gray-600">{cvData.coverLetter?.companyName}</p>
           </div>
           <div className="rich-text-content text-justify leading-relaxed text-sm text-gray-700" dangerouslySetInnerHTML={{ __html: cvData.coverLetter?.content }} />
         </div>
       );
     }

     return (
        <div id="cv-pdf-content" className="flex flex-col items-center bg-gray-100 py-8">
            <style>{globalStyles}</style>
            <style>{richTextStyle}</style>
            
            {/* PAGE 1 - Fixed A4 Layout */}
            <div className="preview-page print-page text-gray-900 font-sans text-sm leading-tight">
                {/* Header Section (Curved Box 1) */}
                <div className="border-2 border-black rounded-[1.5rem] p-6 mb-4 relative shadow-md bg-white flex-shrink-0">
                    <div className="flex justify-between items-center">
                        <div className="flex-1 pr-4">
                            <h1 className="text-3xl font-black uppercase tracking-wide leading-none mb-2" style={{ color: theme }}>{fullName}</h1>
                            <div className="flex items-center gap-2 text-base font-bold text-gray-700">
                                <span className="bg-gray-100 px-2 py-0.5 rounded-md text-xs">{age ? `${age} Years` : 'Age N/A'}</span>
                                <span className="text-gray-300">|</span>
                                <span className="uppercase tracking-wide">{p.title}</span>
                            </div>
                        </div>
                        {/* Passport Photo */}
                        {p.photo ? (
                            <div className="w-[35mm] h-[45mm] bg-gray-200 border-2 border-gray-300 rounded-xl overflow-hidden shadow-sm flex-shrink-0">
                                <img src={p.photo} className="w-full h-full object-cover" alt="Passport Photo" />
                            </div>
                        ) : (
                            <div className="w-[35mm] h-[45mm] bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl flex-shrink-0 flex items-center justify-center text-[10px] text-gray-400 text-center p-1 font-medium">Photo</div>
                        )}
                    </div>
                </div>

                {/* Middle Section - Single Column Stack */}
                <div className="flex flex-col gap-4 mb-4 flex-shrink-0">
                    
                    {/* Application Details - Full Width */}
                    <div className="border-2 border-black rounded-[1.5rem] p-5 bg-gray-50 shadow-sm">
                        <h3 className="text-[10px] font-black uppercase tracking-widest mb-3 border-b border-gray-300 pb-1 text-gray-500 flex items-center gap-1.5">
                            <BriefcaseIcon size={12} className="text-orange-600"/> Application
                        </h3>
                        <div className="grid grid-cols-2 gap-6">
                            <div>
                                <span className="block text-[9px] text-gray-400 uppercase font-bold tracking-wider mb-0.5">Applying For</span>
                                <span className="font-black text-sm text-gray-900 leading-tight block">{jobApply.applyingPost || 'N/A'}</span>
                            </div>
                            <div>
                                <span className="block text-[9px] text-gray-400 uppercase font-bold tracking-wider mb-0.5">Target Country</span>
                                <span className="font-black text-sm text-gray-900 leading-tight block">{jobApply.applyingCountry || 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    {/* Contact Info - Full Width */}
                    <div className="border-2 border-black rounded-[1.5rem] p-5 shadow-sm bg-white">
                        <h3 className="text-[10px] font-black uppercase tracking-widest mb-3 border-b border-gray-200 pb-1 flex items-center gap-1.5" style={{ color: theme }}>
                            <Smartphone size={12} className="text-blue-600"/> Contact Info
                        </h3>
                        <div className="grid grid-cols-3 gap-4 text-xs">
                            {/* Column 1: Phones */}
                            <div className="space-y-2">
                                <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Phone</span><span className="font-bold text-gray-900 truncate">{p.phone || '-'}</span></div>
                                <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">WhatsApp</span><span className="font-bold text-gray-900 text-green-600 truncate">{p.whatsapp || '-'}</span></div>
                                <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Alt Phone</span><span className="font-bold text-gray-900 truncate">{p.alternativePhone || '-'}</span></div>
                            </div>
                            
                            {/* Column 2: Digital */}
                            <div className="space-y-2">
                                <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Email</span><span className="font-bold text-gray-900 truncate" title={p.email}>{p.email || '-'}</span></div>
                                <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Website</span><span className="font-bold text-gray-900 truncate">{p.website || '-'}</span></div>
                            </div>

                            {/* Column 3: Address & Socials */}
                            <div className="space-y-2">
                                <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Address</span><span className="font-medium text-gray-900 leading-tight">{p.postalAddress}{(p.state || p.country) && <span className="block">{[p.state, p.country].filter(Boolean).join(', ')}</span>}{p.pinCode && <span className="block font-bold mt-0.5">PIN: {p.pinCode}</span>}</span></div>
                                { (p.linkedin || p.facebook || p.instagram) && (
                                    <div className="pt-1 mt-1">
                                        <div className="flex flex-col gap-1 text-[10px] font-bold text-gray-600">
                                            {p.linkedin && <span className="flex items-center gap-1 hover:text-blue-700 cursor-pointer truncate"><Linkedin size={10} className="text-blue-700"/> LinkedIn</span>}
                                            {p.facebook && <span className="flex items-center gap-1 hover:text-blue-600 cursor-pointer truncate"><Facebook size={10} className="text-blue-600"/> Facebook</span>}
                                            {p.instagram && <span className="flex items-center gap-1 hover:text-pink-600 cursor-pointer truncate"><Instagram size={10} className="text-pink-600"/> Instagram</span>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Passport & Personal - Full Width */}
                    <div className="border-2 border-black rounded-[1.5rem] p-5 shadow-md bg-white">
                        <h3 className="text-[10px] font-black uppercase tracking-widest mb-4 border-b-2 border-black pb-1 flex items-center gap-1.5" style={{ color: theme }}>
                            <Globe size={12} className="text-teal-600"/> Passport & Personal
                        </h3>
                        <div className="grid grid-cols-4 gap-y-3 gap-x-4 text-xs">
                            <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Passport No.</span><span className="font-black text-gray-900 text-sm">{p.passportNumber || '-'}</span></div>
                            <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Nationality</span><span className="font-bold text-gray-900">{p.nationality || '-'}</span></div>
                            <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Date of Birth</span><span className="font-bold text-gray-900">{p.dob || '-'}</span></div>
                            <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Expires</span><span className="font-bold text-gray-900">{p.passportExpiry || '-'}</span></div>
                            <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Place of Issue</span><span className="font-bold text-gray-900 truncate">{p.placeOfIssue || '-'}</span></div>
                            <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Birth Location</span><span className="font-bold text-gray-900 truncate">{p.stateLocation || '-'}</span></div>
                            <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Gender</span><span className="font-bold text-gray-900">{p.gender || '-'}</span></div>
                            <div className="flex flex-col border-b border-gray-100 pb-1"><span className="text-[9px] font-bold text-gray-400 uppercase">Marital Status</span><span className="font-bold text-gray-900">{p.maritalStatus || '-'}</span></div>
                        </div>
                    </div>

                </div>

                {/* Summary (Curved Box 5) - Expanded to 10 lines */}
                <div className="border-2 border-black rounded-[1.5rem] p-4 shadow-sm bg-white overflow-hidden">
                    <h3 className="text-[10px] font-black uppercase tracking-widest mb-1 border-b-2 border-black pb-0.5 inline-block" style={{ color: theme }}>Professional Summary</h3>
                    <div 
                        className="rich-text-content text-justify text-xs leading-snug text-gray-700 font-medium" 
                        style={{ display: '-webkit-box', WebkitLineClamp: 10, WebkitBoxOrient: 'vertical', overflow: 'hidden' }} 
                        dangerouslySetInnerHTML={{ __html: p.summary }} 
                    />
                </div>
            </div>

            {/* PAGE 2+ (Experience, Education, etc.) - Flowing Page */}
            {/* We allow this to be auto-height for browser pagination, but visually represented as A4 width */}
            <div className="preview-page print-page text-gray-900 font-sans text-sm leading-normal" style={{ height: 'auto', minHeight: '296mm', overflow: 'visible' }}>
                {/* Work Experience */}
                {cvData.cvType !== 'fresher' && cvData.experience?.length > 0 && (
                <div className="mb-6">
                    <h3 className="text-sm font-black uppercase tracking-wider mb-4 border-b-2 border-gray-900 pb-1" style={{ color: theme }}>Work Experience</h3>
                    <div className="space-y-5">
                        {cvData.experience.map((exp, index) => (
                            <div key={index} className="break-inside-avoid">
                                <div className="flex justify-between items-baseline mb-1">
                                    <h4 className="font-bold text-base">{exp.role}</h4>
                                    <span className="text-xs font-bold text-gray-500 border border-gray-300 px-2 py-0.5 rounded whitespace-nowrap">{exp.start}  {exp.end}</span>
                                </div>
                                <div className="text-xs font-bold mb-2 uppercase tracking-wide" style={{ color: theme }}>
                                    {exp.company} <span className="text-gray-400 font-normal normal-case"> {exp.location}</span>
                                </div>
                                <div className="rich-text-content text-xs text-gray-700 leading-relaxed text-justify" dangerouslySetInnerHTML={{ __html: exp.description }} />
                            </div>
                        ))}
                    </div>
                </div>
                )}

                 {/* Education */}
                {cvData.education?.length > 0 && (
                <div className="mb-6 break-inside-avoid">
                    <h3 className="text-sm font-black uppercase tracking-wider mb-4 border-b-2 border-gray-900 pb-1" style={{ color: theme }}>Education</h3>
                    <div className="space-y-3">
                        {cvData.education.map((edu, index) => (
                            <div key={index} className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 border-b border-gray-100 pb-2 last:border-0">
                                <div>
                                    <h4 className="font-bold text-sm">{edu.degree}</h4>
                                    <div className="text-xs text-gray-600 font-medium">{edu.school}</div>
                                    {cvData.cvType === 'fresher' && (edu.cgpa || edu.coursework) && (
                                        <div className="mt-1 text-[10px] text-gray-500">
                                            {edu.cgpa && <span className="mr-3 font-bold bg-gray-100 px-1 rounded">GPA: {edu.cgpa}</span>}
                                        </div>
                                    )}
                                </div>
                                <span className="text-[10px] font-bold text-gray-500 whitespace-nowrap bg-gray-50 px-2 py-1 rounded">{edu.year}</span>
                            </div>
                        ))}
                    </div>
                </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 break-inside-avoid">
                     {/* Languages */}
                    {cvData.languages?.length > 0 && (
                    <div>
                        <h3 className="text-sm font-black uppercase tracking-wider mb-3 border-b-2 border-gray-900 pb-1" style={{ color: theme }}>Languages</h3>
                        <div className="space-y-2">
                             {cvData.languages.map((lang, index) => (
                                 <div key={index} className="flex justify-between items-center text-xs border-b border-gray-100 pb-1 last:border-0">
                                     <span className="font-bold">{lang.name}</span>
                                     <span className="text-gray-500 text-[10px] uppercase">{lang.speak}</span>
                                 </div>
                             ))}
                        </div>
                    </div>
                    )}

                    {/* Skills */}
                    {cvData.skills?.length > 0 && (
                    <div>
                        <h3 className="text-sm font-black uppercase tracking-wider mb-3 border-b-2 border-gray-900 pb-1" style={{ color: theme }}>Skills</h3>
                        <div className="flex flex-wrap gap-1.5">
                             {cvData.skills.map((skill, index) => (
                                 <span key={index} className="px-2 py-1 bg-gray-100 text-gray-800 text-[10px] font-bold rounded border border-gray-200">
                                     {skill}
                                 </span>
                             ))}
                        </div>
                    </div>
                    )}
                </div>
            </div>
        </div>
     );
  };

  const App = () => {
  const [cvData, setCvData] = useState(INITIAL_DATA);
  const [activeTab, setActiveTab] = useState('editor');
  const [expandedSection, setExpandedSection] = useState('personal');
  
  const [aiLoading, setAiLoading] = useState(null); 
  const [isImporting, setIsImporting] = useState(false);
  const [listening, setListening] = useState(false);
  const [listeningTarget, setListeningTarget] = useState(null);
  const [zoom, setZoom] = useState(0.85); 
  const [showExportMenu, setShowExportMenu] = useState(false);
  const [showCropper, setShowCropper] = useState(false);
  const [tempImage, setTempImage] = useState(null);
  const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
  const [showSettings, setShowSettings] = useState(false);
  const [sidebarWidth, setSidebarWidth] = useState(50);
  const [isResizing, setIsResizing] = useState(false);

  const recognitionRef = useRef(null);
  const fileInputRef = useRef(null);
  const exportMenuRef = useRef(null);

  const startResizing = useCallback(() => setIsResizing(true), []);
  const stopResizing = useCallback(() => setIsResizing(false), []);
  const resize = useCallback((e) => {
      if (isResizing) {
          const newWidth = (e.clientX / window.innerWidth) * 100;
          if (newWidth >= 20 && newWidth <= 80) setSidebarWidth(newWidth);
      }
  }, [isResizing]);

  useEffect(() => {
      if (isResizing) {
          window.addEventListener('mousemove', resize);
          window.addEventListener('mouseup', stopResizing);
      } else {
          window.removeEventListener('mousemove', resize);
          window.removeEventListener('mouseup', stopResizing);
      }
      return () => {
          window.removeEventListener('mousemove', resize);
          window.removeEventListener('mouseup', stopResizing);
      };
  }, [isResizing, resize, stopResizing]);

  useEffect(() => {
      const handleClickOutside = (event) => {
          if (exportMenuRef.current && !exportMenuRef.current.contains(event.target)) {
              setShowExportMenu(false);
          }
      };
      document.addEventListener("mousedown", handleClickOutside);
      return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [exportMenuRef]);

  const saveApiKey = (key) => { setApiKey(key); localStorage.setItem('gemini_api_key', key); setShowSettings(false); };

  const callGemini = async (prompt, systemPrompt, base64Data = null, mimeType = null) => {
    // ... (Gemini API logic same as before)
    if (!apiKey) { setShowSettings(true); throw new Error("Please add your API Key in Settings to use AI features."); }
    try {
      const parts = [{ text: prompt }];
      if (base64Data && mimeType) { const cleanBase64 = base64Data.split(',')[1] || base64Data; parts.push({ inlineData: { mimeType: mimeType, data: cleanBase64 } }); }
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: 'user', parts: parts }], systemInstruction: { parts: [{ text: systemPrompt }] } }) });
      if (!response.ok) { const errorData = await response.text(); if (response.status === 403) { setShowSettings(true); throw new Error("Invalid API Key or Permission Denied."); } throw new Error(`AI Service Error: ${response.status} - ${errorData}`); }
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text || '';
    } catch (error) { console.error(error); if (error.message.includes("Please add your API Key")) { setShowSettings(true); } throw error; }
  };

  const handleImportCV = async (e) => {
    // ... (Import logic same as before)
    const file = e.target.files[0];
    if (!file) return;
    setIsImporting(true);
    const reader = new FileReader();
    reader.onload = async () => {
      const base64 = reader.result;
      const mimeType = file.type; 
      const systemPrompt = `You are an expert CV Parser. Your goal is to extract information from the visual image of a resume and output it as a strict JSON object that matches this specific schema. Schema to match: { "personal": { "firstName": "string", "surname": "string", "title": "string", "email": "string", "phone": "string", "country": "string", "state": "string", "summary": "string" }, "experience": [ { "id": number, "role": "string", "company": "string", "start": "string", "end": "string", "description": "string", "location": "string" } ], "education": [ { "id": number, "degree": "string", "school": "string", "year": "string", "category": "Academic" } ], "skills": ["string"], "languages": [ { "id": number, "name": "string", "speak": "Native/Fluent/Intermediate" } ] } Rules: 1. If a field is not found, use an empty string or empty array. 2. For 'description' in experience, combine bullet points into a single string with newlines or bullets. 3. Do not include markdown code blocks. Return ONLY the raw JSON string. 4. Infer 'country' and 'state' from address if possible.`;
      const prompt = "Extract data from this resume image.";
      try {
        const jsonString = await callGemini(prompt, systemPrompt, base64, mimeType);
        if (!jsonString) { throw new Error("No data returned from AI"); }
        const firstBrace = jsonString.indexOf('{');
        const lastBrace = jsonString.lastIndexOf('}');
        if (firstBrace === -1 || lastBrace === -1) { throw new Error("No JSON found in response"); }
        const cleanJson = jsonString.substring(firstBrace, lastBrace + 1);
        const parsedData = JSON.parse(cleanJson);
        const mergedData = { ...INITIAL_DATA, ...parsedData, personal: { ...INITIAL_DATA.personal, ...parsedData.personal }, experience: (parsedData.experience || []).map((e, i) => ({ ...e, id: Date.now() + i })), education: (parsedData.education || []).map((e, i) => ({ ...e, id: Date.now() + i + 100 })), languages: (parsedData.languages || []).map((e, i) => ({ ...e, id: Date.now() + i + 200 })), };
        setCvData(mergedData);
        alert("CV Imported Successfully! Please review the fields.");
      } catch (err) { console.error("Import failed", err); alert(`Failed to parse the CV. Error: ${err.message}`); } finally { setIsImporting(false); if (fileInputRef.current) fileInputRef.current.value = ''; }
    };
    reader.readAsDataURL(file);
  };

  const handleAiAssist = async (type, id = null, customInstruction = "") => {
    // ... (AI logic same as before)
    const loadingKey = id ? `${type}-${id}` : type; setAiLoading(loadingKey);
    try {
      let prompt = ""; let system = "Professional CV writer. Return HTML content."; let result = "";
      if (type === 'summary') { prompt = `Improve summary: "${cvData.personal.summary}". ${customInstruction}`; result = await callGemini(prompt, system); if (result) update('personal.summary', result.trim()); } else if (type === 'exp') { const expItem = cvData.experience.find(i => i.id === id); prompt = `Rewrite responsibilities: "${expItem.description}". ${customInstruction}`; result = await callGemini(prompt, system); if (result) updateArrayItem('experience', id, 'description', result.trim()); } else if (type === 'skills') { prompt = `Suggest skills for ${cvData.personal.title}. ${customInstruction}`; result = await callGemini(prompt, system); if (result) update('skills', result.split(',').map(s => s.trim())); } else if (type === 'cover-letter') { prompt = `Write cover letter for ${cvData.personal.firstName} applying to ${cvData.coverLetter.companyName}. ${customInstruction}`; result = await callGemini(prompt, system); if (result) update('coverLetter.content', result.trim()); }
    } catch (e) { console.error(e); alert(`AI Error: ${e.message}`); } finally { setAiLoading(null); }
  };

  const handlePrint = () => {
    window.print();
    setShowExportMenu(false);
  };

  // --- IMPROVED WORD DOWNLOAD ---
  const handleDownloadWord = () => {
    const element = document.getElementById('cv-pdf-content');
    if (!element) return;
    
    // Inject Styles for Word
    const styles = `
      <style>
        @page {
            size: 21cm 29.7cm;
            margin: 2.54cm;
            mso-page-orientation: portrait;
        }
        body { font-family: 'Arial', sans-serif; font-size: 10pt; line-height: 1.4; color: #333; }
        .preview-page { width: 100%; max-width: 210mm; margin: 0 auto; background: #fff; padding: 0; page-break-after: always; }
        h1 { font-size: 24pt; font-weight: bold; text-transform: uppercase; color: #000; margin-bottom: 5px; }
        h3 { font-size: 12pt; font-weight: bold; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 3px; margin-top: 20px; margin-bottom: 10px; color: #333; }
        p, div, span { font-size: 10pt; }
        .grid { display: table; width: 100%; border-spacing: 10px; }
        .grid-col { display: table-cell; vertical-align: top; }
        .col-5 { width: 40%; }
        .col-7 { width: 60%; }
        .border-box { border: 1px solid #000; padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .text-xs { font-size: 8pt; }
        .font-bold { font-weight: bold; }
        .text-gray-500 { color: #666; }
        .flex { display: flex; }
        .flex-row { flex-direction: row; }
        .items-center { align-items: center; }
        ul { margin: 5px 0 5px 20px; padding: 0; }
        li { margin-bottom: 3px; }
      </style>
    `;

    const content = element.innerHTML
      // Replace some Tailwind classes with inline styles or simpler HTML for Word
      .replace(/class="[^"]*grid[^"]*"/g, 'class="grid"')
      .replace(/class="[^"]*col-span-5[^"]*"/g, 'class="grid-col col-5"')
      .replace(/class="[^"]*col-span-7[^"]*"/g, 'class="grid-col col-7"')
      .replace(/class="[^"]*border-2 border-black[^"]*"/g, 'class="border-box"');

    // Add Office-specific XML for page layout
    const preHtml = `
      <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
      <head>
        <meta charset='utf-8'>
        <title>CV</title>
        <!--[if gte mso 9]>
        <xml>
          <w:WordDocument>
            <w:View>Print</w:View>
            <w:Zoom>100</w:Zoom>
          </w:WordDocument>
        </xml>
        <![endif]-->
        ${styles}
      </head>
      <body>`;
    const postHtml = "</body></html>";
    const html = preHtml + content + postHtml;

    const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${cvData.personal.firstName}_CV.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setShowExportMenu(false);
  };

  const handleDownloadJSON = () => {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cvData, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "cv_backup.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    setShowExportMenu(false);
  };

  useEffect(() => {
    if ('webkitSpeechRecognition' in window) {
      const SpeechRecognition = window.webkitSpeechRecognition;
      recognitionRef.current = new SpeechRecognition();
      recognitionRef.current.continuous = false;
      recognitionRef.current.interimResults = false;
      recognitionRef.current.lang = 'en-US';
      recognitionRef.current.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        if (listeningTarget) {
          if (listeningTarget.type === 'summary') update('personal.summary', (cvData.personal.summary || '') + ' ' + transcript);
          else if (listeningTarget.type === 'exp') { const item = cvData.experience.find(i => i.id === listeningTarget.id); updateArrayItem('experience', listeningTarget.id, 'description', (item.description || '') + ' ' + transcript); }
        }
        setListening(false); setListeningTarget(null);
      };
      recognitionRef.current.onerror = () => setListening(false); recognitionRef.current.onend = () => setListening(false);
    }
  }, [listeningTarget, cvData]);

  const toggleDictation = (type, id = null) => { if (!recognitionRef.current) return alert("Speech recognition is not supported."); if (listening) { recognitionRef.current.stop(); setListening(false); setListeningTarget(null); } else { setListeningTarget({ type, id }); setListening(true); recognitionRef.current.start(); } };
  const update = (path, value) => { setCvData(prev => { const newData = { ...prev }; const keys = path.split('.'); let current = newData; for (let i = 0; i < keys.length - 1; i++) current = current[keys[i]]; current[keys[keys.length - 1]] = value; return newData; }); };
  const updateArrayItem = (section, id, field, value) => { setCvData(prev => ({ ...prev, [section]: prev[section].map(item => item.id === id ? { ...item, [field]: value } : item) })); };
  const addItem = (section) => { const newId = Date.now(); const template = section === 'experience' ? { id: newId, role: 'Role', company: 'Company', location: '', start: '', end: '', description: '' } : section === 'education' ? { id: newId, degree: 'Degree', school: 'School', year: '', category: 'Academic' } : { id: newId, name: 'Language', read: 'Intermediate', write: 'Intermediate', speak: 'Intermediate' }; setCvData(prev => ({ ...prev, [section]: [...prev[section], template] })); };
  const removeItem = (section, id) => { setCvData(prev => ({ ...prev, [section]: prev[section].filter(i => i.id !== id) })); };
  const handleImageUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => { setTempImage(reader.result); setShowCropper(true); e.target.value = ''; }; reader.readAsDataURL(file); } };
  const handleCropSave = (croppedDataUrl) => { update('personal.photo', croppedDataUrl); setShowCropper(false); setTempImage(null); };

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-900 flex flex-col h-screen overflow-hidden selection:bg-black selection:text-white">
      {/* Styles injected here for print are in the GlobalStyles constant inside Preview, but added key ones here for safety */}
      <style>{`
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
      `}</style>

      <nav className="h-18 bg-white border-b-2 border-gray-200 flex items-center justify-between px-6 z-50 no-print flex-shrink-0 shadow-sm">
        {/* ... (Nav content same as before) ... */}
        <div className="flex items-center gap-3">
          <div className="bg-black p-2 rounded-lg text-white shadow-lg"><FileText size={24} strokeWidth={2.5} /></div>
          <div>
            <h1 className="font-black text-lg tracking-tight text-gray-900">CV BUILDER <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">ULTIMATE</span></h1>
            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest -mt-0.5">Professional Edition</p>
          </div>
        </div>
        <div className="flex items-center gap-3 relative">
          <button onClick={() => fileInputRef.current.click()} disabled={isImporting} className={`flex items-center gap-2 px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide transition-all border-2 border-purple-100 text-purple-700 bg-purple-50 hover:bg-purple-100 hover:border-purple-300 shadow-sm ${isImporting ? 'opacity-50 cursor-wait' : ''}`}>
            {isImporting ? <Loader size={16} className="animate-spin" /> : <UploadCloud size={16} strokeWidth={2.5} />}
            {isImporting ? 'Parsing...' : <span className="hidden sm:inline">AI Import</span>}
          </button>
          <input type="file" ref={fileInputRef} onChange={handleImportCV} accept="image/*,application/pdf" className="hidden" />
           <button onClick={() => setShowSettings(true)} className="flex items-center gap-2 px-3 py-2.5 rounded-xl text-gray-500 hover:bg-gray-100 hover:text-black transition-all border-2 border-transparent hover:border-gray-200" title="Settings"><Settings size={20} strokeWidth={2.5} /></button>
           <div className="relative" ref={exportMenuRef}>
            <button onClick={() => setShowExportMenu(!showExportMenu)} className="flex items-center gap-2 bg-black hover:bg-gray-800 text-white px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide transition-all shadow-lg active:scale-95">
              <Download size={16} strokeWidth={2.5} /> <span>Export</span> <ChevronDown size={14} strokeWidth={3} />
            </button>
            {showExportMenu && (
              <div className="absolute right-0 top-full mt-3 w-60 bg-white rounded-2xl shadow-xl border-2 border-gray-100 overflow-hidden z-50 animate-in fade-in zoom-in-95 duration-200">
                <div className="p-2 space-y-1">
                  <button onClick={handlePrint} className="w-full text-left flex items-center gap-3 px-3 py-3 text-sm text-gray-700 hover:bg-gray-50 rounded-xl transition-colors group border border-transparent hover:border-gray-200">
                    <div className="p-2 bg-red-50 text-red-600 rounded-lg group-hover:bg-red-100 transition-colors"><Printer size={20} strokeWidth={2.5} /></div>
                    <div><div className="font-bold text-xs uppercase tracking-wide text-gray-900">PDF (Vector)</div><div className="text-[10px] text-gray-400 font-medium">High Quality Print</div></div>
                  </button>
                  <button onClick={handleDownloadWord} className="w-full text-left flex items-center gap-3 px-3 py-3 text-sm text-gray-700 hover:bg-gray-50 rounded-xl transition-colors group border border-transparent hover:border-gray-200">
                    <div className="p-2 bg-blue-50 text-blue-600 rounded-lg group-hover:bg-blue-100 transition-colors"><FileType size={20} strokeWidth={2.5} /></div>
                    <div><div className="font-bold text-xs uppercase tracking-wide text-gray-900">Word Doc</div><div className="text-[10px] text-gray-400 font-medium">Editable .doc format</div></div>
                  </button>
                  <div className="h-px bg-gray-100 my-1 mx-2"></div>
                  <button onClick={handleDownloadJSON} className="w-full text-left flex items-center gap-3 px-3 py-3 text-sm text-gray-700 hover:bg-gray-50 rounded-xl transition-colors group border border-transparent hover:border-gray-200">
                    <div className="p-2 bg-green-50 text-green-600 rounded-lg group-hover:bg-green-100 transition-colors"><FileJson size={20} strokeWidth={2.5} /></div>
                    <div><div className="font-bold text-xs uppercase tracking-wide text-gray-900">JSON Data</div><div className="text-[10px] text-gray-400 font-medium">Save Backup File</div></div>
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      </nav>

      <main className="flex-1 flex overflow-hidden relative" onMouseUp={stopResizing}>
        <div className="flex flex-col h-full relative no-print" style={{ width: `${sidebarWidth}%` }}>
          <Editor cvData={cvData} update={update} updateArrayItem={updateArrayItem} removeItem={removeItem} addItem={addItem} handleImageUpload={handleImageUpload} handleAiAssist={handleAiAssist} aiLoading={aiLoading} toggleDictation={toggleDictation} listening={listening} listeningTarget={listeningTarget} expandedSection={expandedSection} setExpandedSection={setExpandedSection} JOB_DB={JOB_DB} />
        </div>
        <div className="w-4 bg-gray-200 hover:bg-blue-500 hover:text-white cursor-col-resize flex items-center justify-center z-30 transition-colors border-l border-r border-gray-300 no-print" onMouseDown={startResizing}>
          <GripVertical size={16} className="text-gray-400 pointer-events-none" />
        </div>
        <div className="bg-gray-200/80 backdrop-blur-sm flex flex-col items-center justify-start p-4 md:p-8 overflow-y-auto h-full relative print-container" style={{ width: `${100 - sidebarWidth}%` }}>
           <div className="a4-preview-wrapper origin-top transition-transform duration-200 ease-out rounded-sm ring-1 ring-black/5" style={{ transform: `scale(${zoom})`, transformOrigin: 'top center' }}>
             <Preview cvData={cvData} expandedSection={expandedSection} />
           </div>
           <div className="fixed bottom-8 right-8 flex flex-col gap-2 bg-white/90 backdrop-blur-md shadow-2xl border-2 border-gray-100 p-2 rounded-2xl z-50 no-print ring-1 ring-black/5">
             <button onClick={() => setZoom(z => Math.min(1.5, z + 0.1))} className="p-3 hover:bg-black hover:text-white rounded-xl text-gray-600 transition-all active:scale-95" title="Zoom In"><ZoomIn size={22} strokeWidth={2.5} /></button>
             <div className="h-0.5 w-full bg-gray-100"></div>
             <button onClick={() => setZoom(z => Math.max(0.3, z - 0.1))} className="p-3 hover:bg-black hover:text-white rounded-xl text-gray-600 transition-all active:scale-95" title="Zoom Out"><ZoomOut size={22} strokeWidth={2.5} /></button>
           </div>
        </div>
      </main>

      {showCropper && (
        <ImageCropper imageSrc={tempImage} onCancel={() => { setShowCropper(false); setTempImage(null); }} onSave={handleCropSave} />
      )}
    </div>
  );
};

export default App;